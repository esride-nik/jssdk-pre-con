import{cT as Q,ah as r,ai as l,ak as g,cx as j,cy as c,dk as A,cW as L,cv as E,cD as $,d5 as D,gu as b,mi as X,gn as Y,mj as k,b7 as Z,cA as N,aq as ee,av as te,aw as ie}from"./index-a1cac181.js";import{t as z,p as G}from"./FeatureReductionSelection-02d3f160.js";import{b as O,j as se,l as x}from"./UniqueValueRenderer-3d9243c5.js";import{m as B,o as I,p as ne}from"./jsonUtils-46c07947.js";import{m as U,y as q}from"./commonProperties-7ade9483.js";import{D as J}from"./featureLayerUtils-9cc96c71.js";import{C as H}from"./LabelClass-f01c9855.js";import{x as W}from"./MD5-715f37cd.js";let h=class extends Q(j){constructor(t){super(t),this.expression=null,this.title=null,this.returnType=null}};r([l({type:String,json:{write:!0}})],h.prototype,"expression",void 0),r([l({type:String,json:{write:!0}})],h.prototype,"title",void 0),r([l({type:String,json:{write:!0}})],h.prototype,"returnType",void 0),h=r([g("esri.layers.support.ExpressionInfo")],h);const V=h;var _;let f=_=class extends j{constructor(e){super(e),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new _({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:c(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};r([l({type:Boolean,json:{write:!0}})],f.prototype,"isAutoGenerated",void 0),r([l({type:String,json:{write:!0}})],f.prototype,"name",void 0),r([l({type:String,json:{write:!0}})],f.prototype,"alias",void 0),r([l({type:String,json:{write:!0}})],f.prototype,"onStatisticField",void 0),r([l({type:V,json:{write:!0}})],f.prototype,"onStatisticExpression",void 0),r([l({type:String,json:{write:!0}})],f.prototype,"statisticType",void 0),f=_=r([g("esri.layers.support.AggregateField")],f);const y=f;var F;const re="esri.layers.support.FeatureReductionBinning";let d=F=class extends z{constructor(e){super(e),this.type="binning",this.binType="geohash",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}writeFields(e,t,s){const n=e.filter(o=>o.statisticType!=="avg_angle").map(o=>o.toJSON());D(s,n,t)}readRenderer(e,t,s){var o;const n=(o=t.drawingInfo)==null?void 0:o.renderer;return n?I(n,t,s)??void 0:J(t,s)}clone(){return new F({fields:c(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate),renderer:c(this.renderer)})}};r([A({binning:"binning"})],d.prototype,"type",void 0),r([A({geohash:"geohash"})],d.prototype,"binType",void 0),r([l({type:Number,range:{min:1,max:9},json:{write:!0}})],d.prototype,"fixedBinLevel",void 0),r([l({type:[H],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],d.prototype,"labelingInfo",void 0),r([l(U)],d.prototype,"labelsVisible",void 0),r([l({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],d.prototype,"maxScale",void 0),r([l(q)],d.prototype,"popupEnabled",void 0),r([l({type:L,json:{name:"popupInfo",write:!0}})],d.prototype,"popupTemplate",void 0),r([l({type:[y],json:{write:!0}})],d.prototype,"fields",void 0),r([E("fields")],d.prototype,"writeFields",null),r([l({types:B,json:{write:{target:"drawingInfo.renderer"}}})],d.prototype,"renderer",void 0),r([$("renderer",["drawingInfo.renderer"])],d.prototype,"readRenderer",null),d=F=r([g(re)],d);const K=d;var R;const oe="esri.layers.support.FeatureReductionCluster";function M(e){var t;return e.type==="simple"&&!((t=e.visualVariables)!=null&&t.length)}let p=R=class extends j{constructor(e){super(e),this.type="cluster",this.clusterRadius=b("80px"),this.clusterMinSize=b("12px"),this.clusterMaxSize=b("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}readRenderer(e,t,s){var o,i;const n=(o=t.drawingInfo)==null?void 0:o.renderer;return(i=n==null?void 0:n.authoringInfo)!=null&&i.isAutoGenerated?null:n?M(n)?null:I(n,t,s)??void 0:J(t,s)}readSymbol(e,t,s){var o,i;const n=(o=t.drawingInfo)==null?void 0:o.renderer;if((i=n==null?void 0:n.authoringInfo)!=null&&i.isAutoGenerated)return null;if(n&&M(n)){const a=I(n,t,s);return a==null?void 0:a.symbol}return null}writeSymbol(e,t,s,n){var i,a;const o=(a=(i=this.renderer)==null?void 0:i.authoringInfo)==null?void 0:a.isAutoGenerated;if(!this.renderer||o){const v=new ne({symbol:e});t.drawingInfo={renderer:v.write({},n)}}}writeFields(e,t,s){const n=e.filter(o=>o.statisticType!=="avg_angle").map(o=>o.toJSON());D(s,n,t)}readFields(e,t,s){return e.filter(n=>!n.isAutoGenerated).map(n=>y.fromJSON(n))}clone(){return new R({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,fields:c(this.fields),maxScale:this.maxScale,renderer:c(this.renderer),symbol:c(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate)})}};r([l({type:["cluster"],readOnly:!0,json:{write:!0}})],p.prototype,"type",void 0),r([l({type:Number,cast:e=>e==="auto"?e:b(e),json:{write:!0}})],p.prototype,"clusterRadius",void 0),r([l({type:Number,cast:b,json:{write:!0}})],p.prototype,"clusterMinSize",void 0),r([l({type:Number,cast:b,json:{write:!0}})],p.prototype,"clusterMaxSize",void 0),r([l({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],p.prototype,"maxScale",void 0),r([l(q)],p.prototype,"popupEnabled",void 0),r([l({type:L,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],p.prototype,"popupTemplate",void 0),r([l({types:B,json:{write:{target:"drawingInfo.renderer"}}})],p.prototype,"renderer",void 0),r([$("renderer",["drawingInfo.renderer"])],p.prototype,"readRenderer",null),r([l({types:X})],p.prototype,"symbol",void 0),r([$("symbol",["drawingInfo.renderer"])],p.prototype,"readSymbol",null),r([E("symbol")],p.prototype,"writeSymbol",null),r([l({type:[H],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],p.prototype,"labelingInfo",void 0),r([l(U)],p.prototype,"labelsVisible",void 0),r([l({type:[y],json:{write:!0}})],p.prototype,"fields",void 0),r([E("fields")],p.prototype,"writeFields",null),r([$("fields")],p.prototype,"readFields",null),p=R=r([g(oe)],p);const P=p,C={key:"type",base:z,typeMap:{cluster:P,binning:K}},le={types:{key:"type",base:z,typeMap:{selection:G,cluster:P,binning:K}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:C},"portal-item":{types:C},"web-scene":{types:{key:"type",base:z,typeMap:{selection:G}},name:"layerDefinition.featureReduction",write:{layerContainerTypes:Y}}}}};var T;let S=T=class extends O{writeLevels(e,t,s){for(const n in e){const o=this.levels[n];return void(t.stops=o)}}clone(){var e,t;return new T({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:k(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:k(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:(e=this.stops)==null?void 0:e.map(s=>s.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:(t=this.legendOptions)==null?void 0:t.clone(),levels:c(this.levels)})}};r([l()],S.prototype,"levels",void 0),r([E("levels")],S.prototype,"writeLevels",null),S=T=r([g("esri.views.2d.engine.LevelDependentSizeVariable")],S);const ae=Z.getLogger("esri.views.2d.layers.support.clusterUtils");N.add("esri-cluster-arcade-enabled",!0);const ue=N("esri-cluster-arcade-enabled"),pe=(e,t,s,n,o)=>{const i=t.clone();if(!me(i))return i;if(i.authoringInfo||(i.authoringInfo=new se),i.authoringInfo.isAutoGenerated=!0,"visualVariables"in i){const a=(i.visualVariables||[]).filter(u=>u.valueExpression!=="$view.scale"),v=de(a);a.forEach(u=>{u.type==="rotation"?u.field?u.field=m(e,u.field,"avg_angle","number"):u.valueExpression&&(u.field=w(e,u.valueExpression,"avg_angle","number"),u.valueExpression=null):u.normalizationField?(u.field=m(e,u.field,"avg_norm","number",u.normalizationField),u.normalizationField=null):u.field?u.field=m(e,u.field,"avg","number"):u.valueExpression&&(u.field=w(e,u.valueExpression,"avg","number"),u.valueExpression=null)}),v==null&&!ce(a)&&o&&(a.push(fe(s,n)),i.dynamicClusterSize=!0),i.visualVariables=a}switch(i.type){case"simple":break;case"pie-chart":for(const a of i.attributes)a.field?a.field=m(e,a.field,"sum","number"):a.valueExpression&&(a.field=w(e,a.valueExpression,"sum","number"),a.valueExpression=null);break;case"unique-value":i.field?i.field=m(e,i.field,"mode","string"):i.valueExpression&&(i.field=w(e,i.valueExpression,"mode","string"),i.valueExpression=null);break;case"class-breaks":i.normalizationField?(i.field=m(e,i.field,"avg_norm","number",i.normalizationField),i.normalizationField=null):i.field?i.field=m(e,i.field,"avg","number"):i.valueExpression&&(i.field=w(e,i.valueExpression,"avg","number"),i.valueExpression=null)}return i},de=e=>{for(const t of e)if(t.type==="size")return t;return null},ce=e=>{for(const t of e)if(t.field==="cluster_count")return!0;return!1},fe=(e,t)=>{const s=[new x({value:0,size:0}),new x({value:1})];if(t==null)return new O({field:"cluster_count",stops:[...s,new x({value:2,size:0})]});const n=Object.keys(t).reduce((o,i)=>({...o,[i]:[...s,new x({value:Math.max(2,t[i].minValue),size:e.clusterMinSize}),new x({value:Math.max(3,t[i].maxValue),size:e.clusterMaxSize})]}),{});return new S({field:"cluster_count",levels:n})},me=e=>{const t=s=>ae.error(new ee("Unsupported-renderer",s,{renderer:e}));if(!e)return!1;switch(e.type){case"unique-value":if(e.field2||e.field3)return t("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(e.normalizationField){const s=e.normalizationType;if(s!=="field")return t(`FeatureReductionCluster does not support a normalizationType of ${s}`),!1}break;case"simple":case"pie-chart":break;default:return t(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1}if(!ue){if("valueExpression"in e&&e.valueExpression)return t("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some(s=>!(!("valueExpression"in s)||!s.valueExpression)))return t("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function ye(e,t,s){switch(e){case"sum":return`cluster_sum_${t}`;case"avg":case"avg_angle":return`cluster_avg_${t}`;case"mode":return`cluster_type_${t}`;case"avg_norm":{const n=s,o="field",i=t.toLowerCase()+",norm:"+o+","+n.toLowerCase();return"cluster_avg_"+W(i)}}}function w(e,t,s,n){const o=W(t),i=s==="mode"?`cluster_type_${o}`:s==="sum"?`cluster_sum_${o}`:`cluster_avg_${o}`;return e.some(a=>a.name===i)||e.push(new y({name:i,isAutoGenerated:!0,onStatisticExpression:new V({expression:t,returnType:n}),statisticType:s})),i}function m(e,t,s,n,o){if(t==="cluster_count"||e.some(a=>a.name===t))return t;const i=ye(s,t,o);return e.some(a=>a.name===i)||(s==="avg_norm"?e.push(new y({name:i,isAutoGenerated:!0,onStatisticExpression:new V({expression:`$feature.${t} / $feature.${o}`,returnType:n}),statisticType:"avg"})):e.push(new y({name:i,isAutoGenerated:!0,onStatisticField:t,statisticType:s}))),i}const ze=e=>{let t=class extends e{constructor(...s){super(...s),this.addHandles(te(()=>this.renderer,()=>{if(this.featureReduction){const n=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",n)}},ie))}set featureReduction(s){const n=this._normalizeFeatureReduction(s);this._set("featureReduction",n)}set renderer(s){}_normalizeFeatureReduction(s){var v;if((s==null?void 0:s.type)!=="cluster")return s;const n=s.clone(),o=[new y({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],i=(n.fields??[]).filter(u=>!u.isAutoGenerated);if(s.renderer&&!((v=s.renderer.authoringInfo)!=null&&v.isAutoGenerated))return n.fields=[...o,...i],n;if(s.symbol)return n.fields=[...o,...i],n.renderer=null,n;if(!this.renderer)return s;const a=pe(o,this.renderer,s,null,!1);return n.fields=[...o,...i],n.renderer=a,n}};return r([l(le)],t.prototype,"featureReduction",null),t=r([g("esri.layers.mixins.FeatureReductionLayer")],t),t};export{ze as c};
