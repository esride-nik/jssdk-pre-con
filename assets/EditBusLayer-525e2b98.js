import{fG as $,aF as E,df as H,fD as L,ah as k,ak as x,cy as p}from"./index-a1cac181.js";const T=$(),P=new Map,j=new Map;async function B(t,r,a=!1){var s,n;if(!t||!r)return!0;const d=t.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=(s=j.get(d))==null?void 0:s.entries();if(i){for(const[l,c]of i)if(c.name===r){const u=!((n=c.stack)!=null&&n.hasForwardEdits());if(!u&&a){const[{deleteForwardEdits:m},{default:h}]=await Promise.all([E(()=>import("./deleteForwardEdits-12be3d1b.js"),["./deleteForwardEdits-12be3d1b.js","./index-a1cac181.js","./index-8ff8146e.css"],import.meta.url),E(()=>import("./DeleteForwardEditsParameters-f8a17379.js"),["./DeleteForwardEditsParameters-f8a17379.js","./index-a1cac181.js","./index-8ff8146e.css"],import.meta.url)]);return m(d,l,new h({sessionId:T,moment:c.moment}))}return u}}return!0}function U(t,r){var i;if(!t)return!1;const a=t.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),d=(i=j.get(a))==null?void 0:i.entries();if(d){for(const[s,n]of d)if(n.name===r)return n.lockType==="edit"}return!1}const g=new H.EventEmitter;function D(t){return g.on("apply-edits",new WeakRef(t))}function O(t){return g.on("update-moment",new WeakRef(t))}function C(t,r,a=null,d=!1){const i=L();return d=r==null||d,g.emit("apply-edits",{serviceUrl:t,layerId:r,gdbVersion:a,mayReceiveServiceEdits:d,result:i.promise}),i}const w="esri.layers.mixins.EditBusLayer",A=Symbol(w);function G(t){return t!=null&&typeof t=="object"&&A in t}function f(t){return t!=null&&typeof t=="object"&&"gdbVersion"in t}function b(t,r,a){const d=new URL(t).host,i=P.get(d),s=n=>!n||n===i;return s(r)&&s(a)||r===a}const q=t=>{var r;let a=class extends t{constructor(...d){super(...d),this[r]=!0,this._applyEditsHandler=i=>{const{serviceUrl:s,layerId:n,gdbVersion:l,mayReceiveServiceEdits:c,result:u}=i,m=s===this.url,h=n!=null&&this.layerId!=null&&n===this.layerId,V=f(this),R=f(this)&&b(s,l,this.gdbVersion);if(!m||V&&!R||!h&&!c)return;const S=u.then(e=>{var y;if(h&&(e.addedFeatures.length||e.updatedFeatures.length||e.deletedFeatures.length||e.addedAttachments.length||e.updatedAttachments.length||e.deletedAttachments.length))return this.emit("edits",p(e)),e;const I=(y=e.editedFeatures)==null?void 0:y.find(({layerId:F})=>F===this.layerId);if(I){const{adds:F,updates:M,deletes:v}=I.editedFeatures,_={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map(({attributes:o})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],deletedFeatures:v?v.map(({attributes:o})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],updatedFeatures:M?M.map(({current:{attributes:o}})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],editedFeatures:p(e.editedFeatures),exceededTransferLimit:!1,historicMoment:p(e.historicMoment)};return this.emit("edits",_),_}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:p(e.editedFeatures),exceededTransferLimit:!1,historicMoment:p(e.historicMoment)}}).then(e=>("historicMoment"in this&&this.historicMoment!==e.historicMoment&&U(s,l)&&(this.historicMoment=e.historicMoment),e));this.emit("apply-edits",{result:S})},this._updateMomentHandler=i=>{const{serviceUrl:s,gdbVersion:n,moment:l}=i,c=s===this.url,u=f(this),m=f(this)&&b(s,n,this.gdbVersion),h=f(this)&&!b(s,this.gdbVersion,null);c&&u&&m&&h&&"historicMoment"in this&&this.historicMoment!==l&&(this.historicMoment=l)},this.when().then(()=>{this.addHandles(D(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(O(this._updateMomentHandler))},()=>{})}};return r=A,a=k([x(w)],a),a};export{q as F,U as a,C as c,G as p,T as r,B as s};
